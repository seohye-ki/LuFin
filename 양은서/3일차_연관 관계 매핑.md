# [2025-03-06] 3일차_연관 관계 매핑 (1:N, N:1, M:N)

## 🎯 학습 목표
- 연관 관계 이해
- 테이블 간의 관계를 매핑하는 방법 습득

## 📌 연관 관계 매핑이이란?
- JPA에서는 객체의 필드와 데이터 베이스의 관계를 매핑할 수 있음
    - 기존 JDBC, MyBatis 방식: 외래 키(FK)를 직접 관리
    - JPA 방식: 객체 관계를 활용하여 자동으로 매핑

### 🔹 기존 SQL 방식 (외래 키 직접 관리)
```sql
INSERT INTO team (id, name) VALUES (1, 'Team A');
INSERT INTO member(id, name, team_id) VALUES (1, 'Alice', 1);
```

### 🔹 JPA 방식 (객체 연관 관계 활용)
```java
Team team = new Team("Team A");
teamRepository.save(team);

Member member = new Member("Alice", team);
memberRepository.save(member);
```
### 🔹 JPA 방식의 장점
- SQL을 직접 작성하지 않아도 객체만 다루면 됨
- 외래 키를 직접 관리할 필요 없이, JPA가 자동으로 SQL을 생성

## 📌 연관 관계 매핑(1:N, N:1, M:N)
| 관계 유형 | 설명 | 예제 |
|:----:|:---:|:---:|
| 1:N | 하나의 부모가 여러 자식을 가짐 | 팀 ↔ 멤버 |
| N:1 | 여러 개의 자식이 하나의 부모를 가짐 | 멤버 ↔ 팀 |
| M:N | 다대다 관계 (연결 테이블 필요) | 학생 ↔ 강의 |

## 📌 1:N 관계
- 한 개의 팀이 여러 명의 멤버를 가질 수 있음
- `@OneToMany`를 사용하여 관계 설정정

### 🔹 `@Team` 엔티티

```java
import jakarta.persistence.*;
import lombok.Getter;
import lombok.NoArgsConstructor;
import java.util.ArrayList;
import java.util.List;

@Getter
@NoArgsConstructor
@Entity
public class Team {
    
    @Id
    @GeneratedValue(strategy = GenerateionType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    private String name;
    
    @OneToMany(mappedBy = "team", cascade = CascadeType.ALL) // 1:N 관계
    private List<Member> members = new ArrayList<>();

    public Team(String name){
        this.name = name;
    }
}

```

### 🔹 `@Member` 엔티티

```java
import jakarta.persistence.*;
import lombok.Getter;
import lombok.NoArgsConstructor;

@Getter
@NoArgsConstructor
@Entity
public class Member {
    
    @Id
    @GeneratedValue(strategy = GenerateionType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    private String name;
    
    @ManyToOne // N:1 관계
    @JoinColumn(name = "team_id") // 외래키 설정정
    private Team team;

    public Member(String name, Team team) {
        this.name = name;
        this.team = team;
    }
}

```
- `@OneToMany(mappedBy="team")`
    - **mappedBy**는 `Member` 엔티티의 `team` 필드에 의해 매핑됨을 의미 함
    - `cascade = CascadeType.ALL` → 부모(`Team`)가 삭제되면 자식(`Member`)도 삭제 됨
- `@ManyToOne` & `@JoinColumn(name = "team_id")`
    - `@JoinColumn`을 사용하여 외래 키를 직접 설정 할 수 있음


## 📌 N:1 관계
- 1:N 관계와 동일
- `@ManyToOne`만 사용해도 N:1 관계를 표현할 수 있음
- N쪽이 부모의 정보를 가짐 → 외래 키가 `Member` 테이블에 존재

## 📌 M:N 관계
- ex) 하나의 학생이 여러 강의를 수강할 수 있음
- 하나의 강의도 여러 학생이 들을 수 있음
- 학생 ↔ 강의: 다대다 관계

### 🔹 기본적인 ManyToMany 매핑
```java
@Entity
public class Student {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    private String name;

    @ManyToMany
    @JoinTable(name = "student_course",
        joinColumns = @JoinColumn(name = "student_id"),
        inverseJoinColumns = @JoinColumn(name = "course_id"))
    private List<Course> courses = new ArrayList<>();

}

```

```java
@Entity
public class Course {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Coulmn(nullable = false)
    private String title;

    @ManyToMany(mappedBy = "courses") // ManyToMany 역방향 설정
    private List<Student> student = new ArrayList<>();
}

```
- 연결 테이블 (`student_course`)을 자동으로 생성
- `@JoinTable`을 사용하여 중간 테이블을 직접 지정 가능
- 그러나 ManyToMany 관계 보다 중간 테이블을 따로 엔티티로 관리하는 것이 더욱 유연함
- ManyToMany를 사용하면 이후 컬럼 추가가 어려움
- 1:N, N:1 관계로 풀어서 구현하는 것이 일반적


## 🔗 참고자료

- [Spring Data JPA 공식 문서](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/)
- [Spring Boot 공식 문서](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/)
- [Hibernate 공식 문서](https://hibernate.org/orm/documentation/6.6/)
- [Spring Boot + JPA 가이드](https://spring.io/guides/gs/accessing-data-jpa/)
